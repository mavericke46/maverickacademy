<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VSCode-Style Multi-Page Code Runner</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Fira+Code&display=swap');

  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100vh; width: 100vw;
    font-family: 'Fira Code', monospace;
    background: #1e1e2f;
    color: #ccc;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  header {
    background: #252535;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: inset 0 -1px 0 #4448;
  }

  header input, header select, header button {
    background: #2d2d44;
    border: none;
    color: #eee;
    padding: 8px 14px;
    border-radius: 6px;
    font-size: 15px;
    transition: background 0.3s ease;
  }
  header input::placeholder {
    color: #999;
  }
  header input:focus, header select:focus {
    background: #3e3e6e;
    outline: none;
  }
  header button {
    background: #007acc;
    cursor: pointer;
    font-weight: 700;
  }
  header button:hover {
    background: #005a9e;
  }

  #tabs {
    display: flex;
    background: #252535;
    height: 38px;
    box-shadow: inset 0 -1px 0 #4448;
    overflow-x: auto;
    scrollbar-width: thin;
    scrollbar-color: #007acc40 transparent;
  }
  #tabs::-webkit-scrollbar {
    height: 6px;
  }
  #tabs::-webkit-scrollbar-thumb {
    background-color: #007acc40;
    border-radius: 3px;
  }

  #tabs button {
    background: transparent;
    border: none;
    padding: 6px 16px 7px;
    color: #aaa;
    font-weight: 600;
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 8px;
    position: relative;
    opacity: 0;
    transform: translateY(-10px);
    animation: fadeSlideIn 0.3s forwards;
  }
  #tabs button.active {
    color: #fff;
    border-bottom: 3px solid #007acc;
    font-weight: 700;
  }
  #tabs button:hover {
    background: #2d2d44;
    color: #fff;
  }
  #tabs button span.close-btn {
    font-weight: 700;
    color: #888;
    cursor: pointer;
    font-size: 16px;
    line-height: 1;
    user-select: none;
    transition: color 0.2s ease;
  }
  #tabs button span.close-btn:hover {
    color: #ff5555;
  }

  @keyframes fadeSlideIn {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  #editors-container {
    flex: 1;
    position: relative;
    display: flex;
  }

  .editor {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    display: none;
    flex: 1;
    border-radius: 4px 0 0 0;
    overflow: hidden;
  }
  .editor.active {
    display: block;
  }

  #output-container {
    width: 40%;
    border-left: 2px solid #007acc;
    display: flex;
    flex-direction: column;
  }

  #output-header {
    background: #252535;
    padding: 8px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
    border-bottom: 1px solid #4448;
    color: #eee;
  }
  #output-header button {
    background: #007acc;
    border: none;
    color: white;
    padding: 4px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
  }
  #output-header button:hover {
    background: #005a9e;
  }

  #output-frame {
    flex: 1;
    background: white;
    border: none;
    border-radius: 0 0 4px 0;
  }

  /* Fullscreen overlay */
  #fullscreen-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: #1e1e2f;
    display: none;
    flex-direction: column;
    z-index: 9999;
  }
  #fullscreen-overlay.active {
    display: flex;
  }
  #fullscreen-close {
    background: #ff5555;
    border: none;
    color: white;
    padding: 12px 18px;
    font-weight: 700;
    font-size: 18px;
    cursor: pointer;
    align-self: flex-end;
    margin: 8px 12px 0 0;
    border-radius: 4px;
  }
  #fullscreen-frame {
    flex: 1;
    border: none;
    background: white;
    border-radius: 0 0 4px 4px;
  }

  /* Run button inside editor */
  .run-button {
    position: absolute;
    top: 12px;
    right: 12px;
    background: #007acc;
    border: none;
    color: white;
    padding: 6px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    z-index: 10;
  }
  .run-button:hover {
    background: #005a9e;
  }

</style>
</head>
<body>

<header>
  <input id="newPageName" placeholder="Page name (e.g. index.html)" aria-label="New page name" />
  <select id="newPageLang" aria-label="Select language">
    <option value="html">HTML</option>
    <option value="css">CSS</option>
    <option value="javascript">JavaScript</option>
    <option value="python">Python</option>
  </select>
  <button id="addPageBtn">Add Page</button>
</header>

<div id="tabs" role="tablist" aria-label="Editor pages tabs"></div>

<div id="editors-container"></div>

<div id="output-container" aria-live="polite" aria-atomic="true">
  <div id="output-header">
    Output
    <button id="fullscreenBtn" aria-label="Fullscreen preview">Fullscreen</button>
  </div>
  <iframe id="output-frame" sandbox="allow-scripts allow-same-origin"></iframe>
</div>

<div id="fullscreen-overlay" role="dialog" aria-modal="true" aria-label="Fullscreen output">
  <button id="fullscreen-close" aria-label="Close fullscreen preview">Close ×</button>
  <iframe id="fullscreen-frame" sandbox="allow-scripts allow-same-origin"></iframe>
</div>

<!-- Monaco Editor loader -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>

<script>
  let pages = [];
  let activePageIndex = -1;

  const tabs = document.getElementById('tabs');
  const editorsContainer = document.getElementById('editors-container');
  const outputFrame = document.getElementById('output-frame');
  const fullscreenOverlay = document.getElementById('fullscreen-overlay');
  const fullscreenClose = document.getElementById('fullscreen-close');
  const fullscreenFrame = document.getElementById('fullscreen-frame');
  const fullscreenBtn = document.getElementById('fullscreenBtn');

  const newPageName = document.getElementById('newPageName');
  const newPageLang = document.getElementById('newPageLang');
  const addPageBtn = document.getElementById('addPageBtn');

  let monacoEditors = [];

  // Monaco loader
  require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs' }});
  require(['vs/editor/editor.main'], function() {

    addPageBtn.onclick = () => {
      const name = newPageName.value.trim();
      const lang = newPageLang.value;

      if(!name) {
        alert("Please enter a valid page name.");
        return;
      }
      createPage(name, lang);
      newPageName.value = '';
    };

    createPage('index.html', 'html');
    createPage('styles.css', 'css');
    createPage('script.js', 'javascript');
  });

  function createPage(name, lang) {
    // Create tab button
    const tab = document.createElement('button');
    tab.className = 'tab-button';
    tab.setAttribute('role', 'tab');
    tab.setAttribute('aria-selected', 'false');
    tab.setAttribute('tabindex', '-1');
    tab.title = name;

    const label = document.createElement('span');
    label.textContent = name;

    const closeBtn = document.createElement('span');
    closeBtn.className = 'close-btn';
    closeBtn.textContent = '×';
    closeBtn.title = "Close tab";

    closeBtn.onclick = (e) => {
      e.stopPropagation();
      deletePage(tab);
    };

    tab.onclick = () => {
      const idx = pages.findIndex(p => p.tab === tab);
      setActivePage(idx);
    };

    tab.appendChild(label);
    tab.appendChild(closeBtn);
    tabs.appendChild(tab);

    // Create editor container
    const editorDiv = document.createElement('div');
    editorDiv.className = 'editor';
    editorsContainer.appendChild(editorDiv);

    // Create Run button inside editor container
    const runBtn = document.createElement('button');
    runBtn.className = 'run-button';
    runBtn.textContent = 'Run';
    runBtn.title = "Run this page's code";
    editorDiv.appendChild(runBtn);

    // Create Monaco editor
    const editor = monaco.editor.create(editorDiv, {
      value: getDefaultCode(lang),
      language: lang,
      theme: 'vs-dark',
      automaticLayout: true,
      minimap: { enabled: false },
      fontSize: 14,
      scrollBeyondLastLine: false,
    });

    runBtn.onclick = () => runCode();

    pages.push({name, lang, tab, editor, editorDiv});
    monacoEditors.push(editor);

    setActivePage(pages.length - 1);

    editor.onDidChangeModelContent(() => validateCode(pages.length -1));
  }

  function deletePage(tabToDelete) {
    const idx = pages.findIndex(p => p.tab === tabToDelete);
    if(idx === -1) return;

    pages[idx].editor.dispose();
    pages[idx].tab.remove();
    pages[idx].editorDiv.remove();

    pages.splice(idx, 1);
    monacoEditors.splice(idx, 1);

    if(activePageIndex === idx) {
      if(pages.length === 0) {
        activePageIndex = -1;
        clearOutput();
      } else if(idx === pages.length) {
        setActivePage(idx - 1);
      } else {
        setActivePage(idx);
      }
    } else if(activePageIndex > idx) {
      activePageIndex--;
    }
  }

  function setActivePage(idx) {
    if(idx < 0 || idx >= pages.length) return;

    pages.forEach((p,i) => {
      p.tab.classList.toggle('active', i === idx);
      p.tab.setAttribute('aria-selected', i === idx ? 'true' : 'false');
      p.tab.tabIndex = i === idx ? 0 : -1;
      p.editorDiv.classList.toggle('active', i === idx);
    });

    activePageIndex = idx;
    validateCode(idx);
  }

  function getDefaultCode(lang) {
    switch(lang) {
      case 'html': return '<!-- Start typing your HTML here -->\n<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <title>Document</title>\n</head>\n<body>\n\n</body>\n</html>';
      case 'css': return '/* Start typing CSS here */\nbody {\n  background-color: #1e1e2f;\n  color: #ccc;\n}';
      case 'javascript': return '// Start typing JavaScript here\nconsole.log("Hello world!");';
      case 'python': return '# Start typing Python here\nprint("Hello world!")';
      default: return '';
    }
  }

  // Validate code syntax simply and set border colors
  function validateCode(idx) {
    if(idx < 0 || idx >= pages.length) return;

    const page = pages[idx];
    const code = page.editor.getValue();
    const lang = page.lang;

    if(lang === 'html') {
      const openTags = (code.match(/<[^\/!][^>]*>/g) || []).length;
      const closeTags = (code.match(/<\/[^>]+>/g) || []).length;
      if(openTags !== closeTags) {
        setEditorColor(page.editor, 'red');
      } else {
        setEditorColor(page.editor, '#007acc');
      }
    } else if(lang === 'css') {
      const openBraces = (code.match(/{/g) || []).length;
      const closeBraces = (code.match(/}/g) || []).length;
      if(openBraces !== closeBraces) {
        setEditorColor(page.editor, 'red');
      } else {
        setEditorColor(page.editor, '#007acc');
      }
    } else if(lang === 'javascript') {
      try {
        new Function(code);
        setEditorColor(page.editor, '#007acc');
      } catch(e) {
        setEditorColor(page.editor, 'red');
      }
    } else {
      setEditorColor(page.editor, '#007acc');
    }
  }

  function setEditorColor(editor, color) {
    const domNode = editor.getDomNode();
    if(domNode) {
      domNode.style.border = `3px solid ${color}`;
      domNode.style.borderRadius = '6px';
    }
  }

  function clearOutput() {
    outputFrame.srcdoc = '';
    fullscreenFrame.srcdoc = '';
  }

  // Run code: combine all tabs' code into one live preview
  function runCode() {
    // Collect code from tabs
    let htmlCode = '';
    let cssCode = '';
    let jsCode = '';

    pages.forEach(({lang, editor}) => {
      const val = editor.getValue();
      if(lang === 'html') htmlCode = val;
      else if(lang === 'css') cssCode = val;
      else if(lang === 'javascript') jsCode = val;
    });

    // Compose full html with CSS and JS
    const fullCode = `
      <!DOCTYPE html>
      <html lang="en">
      <head>
        <style>${cssCode}</style>
      </head>
      <body>
        ${htmlCode}
        <script>
          window.onerror = function(msg, url, lineNo, columnNo, error) {
            window.parent.postMessage({type: 'js-error', message: msg + " at line " + lineNo}, "*");
          };
          try {
            ${jsCode}
          } catch (e) {
            window.parent.postMessage({type: 'js-error', message: e.message}, "*");
          }
        <\/script>
      </body>
      </html>
    `;

    outputFrame.srcdoc = fullCode;
    fullscreenFrame.srcdoc = fullCode;
  }

  // Listen for errors from iframe
  window.addEventListener('message', e => {
    if(e.data?.type === 'js-error') {
      alert("JavaScript runtime error:\n" + e.data.message);
    }
  });

  // Fullscreen preview toggle
  fullscreenBtn.onclick = () => {
    fullscreenOverlay.classList.add('active');
  };
  fullscreenClose.onclick = () => {
    fullscreenOverlay.classList.remove('active');
  };

</script>

</body>
</html>
